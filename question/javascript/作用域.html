<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>变量、作用域和内存问题 | 煮酒论前端</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/docs/light.jpg">
    <meta name="description" content="助力前端开发者渐入佳境">
    <link rel="preload" href="/docs/assets/css/0.styles.c5b0a4e8.css" as="style"><link rel="preload" href="/docs/assets/js/app.270217f1.js" as="script"><link rel="preload" href="/docs/assets/js/2.e3991cd2.js" as="script"><link rel="preload" href="/docs/assets/js/9.a0fc5c6a.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.ebc3f905.js"><link rel="prefetch" href="/docs/assets/js/11.0f305428.js"><link rel="prefetch" href="/docs/assets/js/12.c338372d.js"><link rel="prefetch" href="/docs/assets/js/3.77384424.js"><link rel="prefetch" href="/docs/assets/js/4.283fb0ce.js"><link rel="prefetch" href="/docs/assets/js/5.5f4834c7.js"><link rel="prefetch" href="/docs/assets/js/6.a8e0e21b.js"><link rel="prefetch" href="/docs/assets/js/7.595a85ef.js"><link rel="prefetch" href="/docs/assets/js/8.f723beab.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.c5b0a4e8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">煮酒论前端</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/docs/question/" class="nav-link router-link-active">
  每日一论
</a></div> <a href="https://github.com/cangliuqi/cangliuqi.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/docs/question/" class="nav-link router-link-active">
  每日一论
</a></div> <a href="https://github.com/cangliuqi/cangliuqi.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/question/javascript/作用域.html" class="active sidebar-link">变量、作用域和内存问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/question/javascript/作用域.html#_1-null-undefined为什么为true" class="sidebar-link">1.null==undefined为什么为true</a></li><li class="sidebar-sub-header"><a href="/docs/question/javascript/作用域.html#_2-介绍一下javascript中的垃圾回收机制" class="sidebar-link">2.介绍一下JavaScript中的垃圾回收机制</a></li><li class="sidebar-sub-header"><a href="/docs/question/javascript/作用域.html#_3-对this有什么理解" class="sidebar-link">3.对this有什么理解</a></li><li class="sidebar-sub-header"><a href="/docs/question/javascript/作用域.html#_4-bind、apply、call有什么区别，如何用javascript原生代码实现bind、apply和call方法" class="sidebar-link">4.bind、apply、call有什么区别，如何用JavaScript原生代码实现bind、apply和call方法</a></li><li class="sidebar-sub-header"><a href="/docs/question/javascript/作用域.html#_5-谈谈对闭包的理解" class="sidebar-link">5.谈谈对闭包的理解</a></li></ul></li><li><a href="/docs/question/javascript/引用类型.html" class="sidebar-link">引用类型</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="变量、作用域和内存问题"><a href="#变量、作用域和内存问题" class="header-anchor">#</a> 变量、作用域和内存问题</h1> <h2 id="_1-null-undefined为什么为true"><a href="#_1-null-undefined为什么为true" class="header-anchor">#</a> 1.null==undefined为什么为true</h2> <p>null和undefined本身在含义上是非常接近的，其实最开始在JavaScript中只有null。后来JavaScript的发明者认为null被当作对象，而表示无的值最好不是对象；同时当时JavaScript没有错误处理机制，如果null自动转为0不容易发现错误。在这两个原因的驱使下，他设计了undefined，并规定：</p> <ul><li>null是一个表示无的对象，转为数值的时候为0</li> <li>undefined是一个表示无的原始值，转为数值时为NaN</li></ul> <p>但在实践中，null和undefined基本同义，只有一些小的不同：</p> <ul><li><p>null表示“没有对象”，即此处不该有值。比如：</p> <ul><li>作为函数的参数，表示该函数的参数不是对象。</li> <li>作为对象原型链的终点：Object.getPrototypeOf(Object.prototype)</li></ul></li> <li><p>undefined表示“缺少值”，即此处应该有一个值，但是还没有定义。比如：</p> <ul><li>变量声明了，但没有赋值的时候，等于undefined</li> <li>调用函数时，应该提供的参数没有提供，该参数等于undefined</li> <li>对象没有赋值的属性，该属性的值为undefined</li> <li>函数没有返回值时，默认返回undefined</li></ul></li></ul> <h2 id="_2-介绍一下javascript中的垃圾回收机制"><a href="#_2-介绍一下javascript中的垃圾回收机制" class="header-anchor">#</a> 2.介绍一下JavaScript中的垃圾回收机制</h2> <h3 id="垃圾回收机制的含义"><a href="#垃圾回收机制的含义" class="header-anchor">#</a> 垃圾回收机制的含义</h3> <p>我们知道，JavaScript对程序执行时候所需内存的分配以及无用内存的回收，均由JavaScript引擎自动管理。其自动回收无用内存的行为我们称之为垃圾回收。垃圾回收机制的核心原理，是JavaScript引擎周期性的寻找那些不再使用的变量，然后释放其占用的内存。
而如何确定变量是否已经无用，在浏览器中的JavaScript引擎有两个策略：</p> <h3 id="标记清楚策略"><a href="#标记清楚策略" class="header-anchor">#</a> 标记清楚策略</h3> <p>垃圾收集器在运行的时候会给存储在内存中的所有变量都加上标记，随后会去掉环境中的变量以及被环境中变量引用的变量的标记，剩下的还有标记的变量将被视为需要删除的变量。确定好需要删除的变量后，垃圾收集器会销毁那些带有标记的值并回收它们所占的内存空间，完成内存清除工作。标记清除（mark-and-sweep）机制也是JavaScript中最常用的垃圾收集方式，2008年以前，IE、Firefox、Opera、Chrome和Safari的JavaScript实现使用的都是标记清除式的垃圾收集策略，只是在垃圾收集的时间间隔上有所不同。</p> <h3 id="引用计数策略"><a href="#引用计数策略" class="header-anchor">#</a> 引用计数策略</h3> <p>引用计数（reference counting）策略存在着循环引用的问题，是一个是一个有缺陷的策略，已被Netscape Navigator弃用。之所以存在缺陷，是因为引用计数的主要思想就是跟踪记录每个值被引用的次数：当声明了一个变量并将一个引用类型值赋给该变量，则这个值的引用次数就是1。如果同一个值又被赋给另一个变量，则该值的引用次数加1。相反，如果包含对这个值引用的变量又取得另外一个值，则这个值的引用次数减1。当这个值的引用次数变成0时，则没有办法再访问这个值，因而就可以将其占用的内存空间回收。当垃圾收集器下次运行的时候，就会释放那些引用次数为零的值所占用的内存。在这种背景下，如果A对象包含一个指向B对象的指针，而B对象也包含一个指向A对象的引用，就会出现循环引用。</p> <p>虽然Netscape Navigator已经弃用了引用计数的方式。但是由于在IE中，部分对象并不是原生JavaScript对象。比如BOM和DOM对象就是C++以COM（Component Object Model，组件对象模型）对象的形式实现的，而COM对象的垃圾收集机制采用的就是引用计数策略，因此只要在IE中涉及COM对象，就会存在循环引用的问题。例如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;some_anyment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">.</span>element <span class="token operator">=</span> element<span class="token punctuation">;</span>
element<span class="token punctuation">.</span>someObject <span class="token operator">=</span> myObject<span class="token punctuation">;</span>
</code></pre></div><p>为了解决上述问题，IE9把BOM和DOM对象都转换成了真正的JavaScript对象，这就避免了两种垃圾收集算法并存导致的问题，也消除了常见的内存泄露现象。</p> <h3 id="垃圾回收机制引发的思考"><a href="#垃圾回收机制引发的思考" class="header-anchor">#</a> 垃圾回收机制引发的思考</h3> <h4 id="垃圾收集机制的性能问题"><a href="#垃圾收集机制的性能问题" class="header-anchor">#</a> 垃圾收集机制的性能问题</h4> <p>由于垃圾收集的工作是周期不间断执行的，如果执行的时间间隔过短，无疑会引起性能问题，特别是在变量分配的内存数量较大的情况下，更会引起严重的性能问题。IE6及以前因其垃圾收集器会频繁运行导致了较坏的影响，IE7调整了其垃圾收集机制，降低了垃圾收集器运行的频率。在IE中，调用window.CollectGarbage()方法会立即执行垃圾收集，在Opera7及更高版本中，调用window.opera.collect（）也会启动垃圾收集程序，但是不建议这么做。</p> <h4 id="内存管理"><a href="#内存管理" class="header-anchor">#</a> 内存管理</h4> <p>虽然JavaScript有垃圾收集机制，内存会被自动回收，但是为了防止运行JavaScript的网页耗尽系统全部内存导致系统崩溃，因此分配给Web浏览器的可用内存相较于桌面应用程序更少。内存的限制会影响给变量分配内存，同时也会影响调用栈以及在一个线程中能够同时执行的语句数量。因此前端开发者有义务保证用最少的内存让页面获得更好的性能。</p> <p>优化内存的最直接的方式，就是让执行中的代码只保存必要的数据。一旦数据不再有用，最好通过将其值设置为 null 来释放其引用——这个做法叫做解除引用（dereferencing）。这一做法适用于大多数全局变量和全局对象的属性。局部变量会在它们离开执行环境时自动被解除引用，如下面这个例子所示：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">var</span> localPerson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    localPerson<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span> 
    <span class="token keyword">return</span> localPerson<span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">var</span> globalPerson <span class="token operator">=</span> <span class="token function">createPerson</span><span class="token punctuation">(</span><span class="token string">&quot;Nicholas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 手工解除 globalPerson 的引用 </span>
globalPerson <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
</code></pre></div><p>上例中createPerson函数在执行完后会离开环境，因此无需手动解除引用。但对于全局对象而言，则需要我们在不再使用该变量的时候，手动解除引用。让其脱离执行环境，以便垃圾收集器下次运行时将其回收。</p> <h2 id="_3-对this有什么理解"><a href="#_3-对this有什么理解" class="header-anchor">#</a> 3.对this有什么理解</h2> <p>可以简单的说，this 是谁调用的this所在的函数或方法，那么this就指向其。具体点，可以这样认为，当一个函数被调用时，会创建一个活动记录（有时候也称为执行上下文）。这个记录会包含函数在哪里被调用（调用栈）、函数的调用方法、传入的参数信息。this就是记录的其中一个属性，会在函数执行的过程中用到。总之this的绑定和函数声明的位置没有任何关系，只取决于函数的调用方式。再细化一点，this到底绑定了哪一个上下文环境，也就是说this到底指向了谁，需要我们遵从一定的规则来判断：</p> <p><img src="http://jiaci-file.oss-cn-beijing.aliyuncs.com/jiaci/images/20200515/JavaScriptthis.jpg" alt="image-20200515094707571"></p> <h2 id="_4-bind、apply、call有什么区别，如何用javascript原生代码实现bind、apply和call方法"><a href="#_4-bind、apply、call有什么区别，如何用javascript原生代码实现bind、apply和call方法" class="header-anchor">#</a> 4.bind、apply、call有什么区别，如何用JavaScript原生代码实现bind、apply和call方法</h2> <h3 id="异同点"><a href="#异同点" class="header-anchor">#</a> 异同点</h3> <p>四个相同点：</p> <ul><li>apply、call、bind 三者都是用来改变函数this对象的指向；</li> <li>apply、call、bind 三者第一个参数都是this要指向的对象，也就是指定的上下文；</li> <li>apply、call、bind 三者都可以利用后续参数传参；</li> <li>当bind方法第一个参数为null、undefined的时候，默认指向window；
两个不同点：</li> <li>bind是返回对应的函数，便于稍后调用。apply、call 则是立即调用。 call()、apply()可以看做是某个对象的方法，通过调用方法的形式来间接的调用函数。bind()就是将某个函数绑定到某个对象上；</li> <li>apply的第二个参数是数组，而call和bind从第二个参数开始接收参数列表；</li></ul> <h3 id="原生实现"><a href="#原生实现" class="header-anchor">#</a> 原生实现</h3> <h4 id="原生实现call"><a href="#原生实现call" class="header-anchor">#</a> 原生实现call</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//方法一，ES6前实现方式</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">call_</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    obj <span class="token operator">=</span> obj<span class="token operator">?</span><span class="token function">Object</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token operator">:</span>window<span class="token punctuation">;</span>
    <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> len <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;arguments[&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    obj<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;obj.fn(&quot;</span> <span class="token operator">+</span> args <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//方法二，ES6实现方式</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">call_</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj <span class="token operator">=</span> obj <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 利用拓展运算符直接将arguments转为数组</span>
    <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arguments<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>fn
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="原生实现apply"><a href="#原生实现apply" class="header-anchor">#</a> 原生实现apply</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//方法一，ES6之前的实现方式</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply_</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj <span class="token operator">=</span> obj <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 注意这里的i从0开始</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;arr[&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;obj.fn(&quot;</span> <span class="token operator">+</span> args <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行fn</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>fn<span class="token punctuation">;</span> <span class="token comment">//删除fn</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//方法二，ES6实现方式</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply_</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj <span class="token operator">=</span> obj <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>fn
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="原生实现bind"><a href="#原生实现bind" class="header-anchor">#</a> 原生实现bind</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//方法一</span>
<span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">my_bind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">// 保存原函数</span>
    context <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 保存需要绑定的this上下文</span>
    <span class="token comment">// 上一行等价于 context = [].shift.call(arguments);</span>
    args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 剩余的参数转为数组</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 返回一个新函数</span>
    <span class="token function">self</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//方法二</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bind<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">oThis</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span> <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// closest thing possible to the ECMAScript 5 internal IsCallable function</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Function.prototype.bind - what is trying to be bound is not callable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> aArgs <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        fToBind <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> 
        <span class="token function-variable function">fNOP</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">fBound</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">fToBind</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">fNOP</span> <span class="token operator">&amp;&amp;</span> oThis
                                 <span class="token operator">?</span> <span class="token keyword">this</span>
                                 <span class="token operator">:</span> oThis <span class="token operator">||</span> window<span class="token punctuation">,</span>
                               aArgs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

    fNOP<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    fBound<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fNOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fBound<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-谈谈对闭包的理解"><a href="#_5-谈谈对闭包的理解" class="header-anchor">#</a> 5.谈谈对闭包的理解</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>闭包，是指有权访问另一个函数作用域中的变量的函数。</p> <h3 id="创建的特征"><a href="#创建的特征" class="header-anchor">#</a> 创建的特征</h3> <ul><li>函数内部创建一个函数</li> <li>函数内部可以引用外部的参数和变量</li> <li>参数和变量不会被垃圾回收器回收</li></ul> <h3 id="适用场景"><a href="#适用场景" class="header-anchor">#</a> 适用场景</h3> <ul><li>对于没必要对外提供的函数，使用闭包，避免变量污染</li> <li>当希望保存函数调用结果而不被垃圾收集器回收时可以使用闭包，例如</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> count<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function-variable function">addFun</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        n<span class="token operator">+=</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> inner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> resultFun<span class="token operator">=</span><span class="token function">outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">resultFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100</span>
<span class="token function">addFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">resultFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 101</span>
<span class="token comment">/**addFun在该例中是一个全局函数，inner函数持有了outer的变量count，outer执行完后，并不会被垃圾收集器收集*/</span>
</code></pre></div><h3 id="使用闭包的优点和缺点"><a href="#使用闭包的优点和缺点" class="header-anchor">#</a> 使用闭包的优点和缺点</h3> <ul><li>优点
<ul><li>避免全局变量污染</li> <li>内部函数可以访问外部函数的变量</li> <li>可以让访问到的变量始终保存在内存中（也是缺点）</li></ul></li> <li>缺点
<ul><li>闭包会常驻内存，会增大内存使用量，使用不当很容易造成内存泄露</li></ul></li></ul> <h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <ul><li>在退出函数之前，将不使用的局部变量全部删除，避免内存泄露</li> <li>闭包会在父函数外部，改变父函数内部变量的值。如果你把父函数当作对象（object）使用，把闭包当作它的公用方法（Public Method），把内部变量当作它的私有属性（private value），这时一定要小心，不要随便改变父函数内部变量的值。</li></ul> <h3 id="关注公众号"><a href="#关注公众号" class="header-anchor">#</a> 关注公众号</h3> <p>读者朋友们可以扫码二维码关注微信公众号，每日更新，共同进步
<img src="http://jiaci-file.oss-cn-beijing.aliyuncs.com/jiaci/images/20200514/qrcode.jpg" alt="公众号"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/docs/question/javascript/引用类型.html">
        引用类型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.270217f1.js" defer></script><script src="/docs/assets/js/2.e3991cd2.js" defer></script><script src="/docs/assets/js/9.a0fc5c6a.js" defer></script>
  </body>
</html>
